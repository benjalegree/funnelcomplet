<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>PsicoFunnel — Creador (MVP)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="color-scheme" content="light">
<style>
/* =========================
   PsicoFunnel — Home MVP
   Estética: blanco predominante + liquid glass + acentos azul
   ========================= */
:root{
  /* Tema */
  --bg:#f7f9fc;                 /* blanco suave */
  --bg-grad: radial-gradient(1200px 800px at 20% -10%, #eaf2ff 0%, rgba(234,242,255,0) 60%),
               radial-gradient(800px 600px at 120% 10%, #f0f7ff 0%, rgba(240,247,255,0) 58%),
               radial-gradient(600px 500px at 80% 90%, #e8f1ff 0%, rgba(232,241,255,0) 68%);
  --card: rgba(255,255,255,.7);
  --border: rgba(11,95,255,.15);
  --shadow-lg: 0 24px 40px rgba(11,95,255,.10), 0 6px 14px rgba(2,6,23,.06);
  --shadow-sm: 0 6px 16px rgba(2,6,23,.06);
  --glass-blur: 10px;

  /* Colores base */
  --primary:#0b5fff;  /* azul fuerte */
  --accent:#0ea5e9;   /* celeste */
  --text:#0b1220;     /* casi-negro */
  --muted:#475569;    /* slate */
  --success:#0CE756;  /* verde éxito */

  /* Tipografía y radio */
  --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
  --radius-xl: 16px; --radius-2xl: 20px; --radius-3xl: 28px;

  /* Layout */
  --max-w: 1200px;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font: 500 14px/1.5 var(--font); color:var(--text);
  background: var(--bg);
  background-image: var(--bg-grad);
  min-height:100%;
}

/* Utilidades */
.container{max-width:var(--max-w); margin:0 auto; padding:0 20px}
.glass{
  background:var(--card);
  border:1px solid var(--border);
  backdrop-filter:saturate(1.35) blur(var(--glass-blur));
  -webkit-backdrop-filter:saturate(1.35) blur(var(--glass-blur));
  border-radius:var(--radius-2xl);
  box-shadow:var(--shadow-lg);
}
.btn{
  display:inline-flex; align-items:center; gap:10px;
  padding:10px 14px; border:0; border-radius:999px; cursor:pointer;
  font-weight:800; letter-spacing:.2px;
  background:linear-gradient(135deg, #0b5fff, #0ea5e9);
  color:#fff;
}
.btn.secondary{
  background:transparent; color:#0b5fff; border:1px solid rgba(11,95,255,.25);
}
.btn.icon svg{flex:0 0 auto}

/* NAV */
.nav{ position: sticky; top:0; z-index:50; }
.nav .inner{
  display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 12px; margin-top:10px;
}
.brand{display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.3px}
.logo{
  width:34px; height:34px; border-radius:999px;
  background: radial-gradient(circle at 30% 30%, #0ea5e9 0%, #0b5fff 65%, #082a7a 100%);
  box-shadow: 0 6px 16px rgba(11,95,255,.35) inset, 0 8px 18px rgba(11,95,255,.18);
}
.badge{
  margin-left:8px; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:800; color:#0b3aa6;
  background:rgba(255,255,255,.6); border:1px solid rgba(11,95,255,.15);
}
.tabs{display:flex; gap:8px; align-items:center}
.tabs .hint{font-size:12px; color:var(--muted)}
.tabs .sp{width:1px; height:18px; background:rgba(11,95,255,.15)}
.tabs .group{display:flex; gap:6px; align-items:center}
.tab{
  padding:10px 14px; border-radius:999px; font-weight:700; font-size:14px;
  background:rgba(255,255,255,.7); border:1px solid rgba(11,95,255,.15); cursor:pointer;
}
.tab.active{background:linear-gradient(135deg,rgba(11,95,255,.15), rgba(14,165,233,.15)); color:#0b3aa6}
.login{display:flex; align-items:center; gap:10px; margin-left:10px}
.logged #loginStatus{color:var(--success); font-weight:700}

/* Login UI polish */
.login {
  display:flex; align-items:center; gap:12px; margin-left:10px; padding:6px 10px;
  border-radius:999px; background:rgba(255,255,255,.6); border:1px solid rgba(11,95,255,.14);
}
#btnGoogle > div { transform: scale(0.95); transform-origin:left center; }
.logged .login { background:rgba(12, 231, 86, .08); border-color: rgba(12,231,86,.25); }

/* Header pregunta + CTA */
.header-hero{ padding:34px 0 18px; text-align:center; }
.title{
  font-size: clamp(28px, 4vw, 44px);
  line-height:1.05; font-weight:900; letter-spacing:-.02em; margin:10px 0 8px;
  background:linear-gradient(120deg,#0b5fff 0%,#0ea5e9 35%,#0b5fff 70%);
  -webkit-background-clip:text; background-clip:text; color:transparent;
}
.subtitle{ margin:0 auto 18px; max-width:800px; color:var(--muted) }

/* Plantillas estilo “Canva” */
.templates{
  margin:20px auto 8px; display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:center;
}
.template{
  display:flex; align-items:center; gap:10px; padding:10px 14px; border-radius:999px; cursor:pointer;
  border:1px solid rgba(11,95,255,.15); background:rgba(255,255,255,.65); box-shadow:var(--shadow-sm);
  transition:.2s transform ease, .2s box-shadow ease;
}
.template:hover{ transform: translateY(-2px); box-shadow:0 8px 20px rgba(11,95,255,.14) }
.icon-glass{
  width:34px; height:34px; border-radius:999px; display:grid; place-items:center;
  background: linear-gradient(135deg, rgba(11,95,255,.16), rgba(14,165,233,.16));
  border:1px solid rgba(11,95,255,.22);
}
.template .name{ font-weight:800; letter-spacing:.2px }

/* Panel central (chat-style) */
.main{
  display:grid; grid-template-columns: minmax(0,1fr) 380px; gap:16px; align-items:start; padding:10px 0 34px;
}
.left .panel{
  min-height:420px; padding:16px; border-radius:var(--radius-2xl);
  display:grid; grid-template-rows: 1fr auto; gap:12px;
}
.pane{
  background:rgba(255,255,255,.7); border-radius:var(--radius-xl); border:1px solid rgba(11,95,255,.18);
  padding:12px; overflow:auto; max-height:min(56vh, 580px);
}
.msg{ display:flex; gap:10px; margin-bottom:10px }
.msg.system{ color:#0b3aa6; font-weight:700 }
.msg.assistant{ color:#082a7a }
.msg.user{ color:#0b1220 }
.composer{
  border:1px dashed rgba(11,95,255,.28); border-radius:16px; padding:10px; background:rgba(255,255,255,.8);
  display:flex; align-items:center; gap:10px;
}
.composer textarea{
  width:100%; min-height:62px; border:0; outline:0; resize:vertical; background:transparent; font:500 14px var(--font)
}

/* Panel derecho */
.right .panel{
  padding:16px; border-radius:var(--radius-2xl); display:grid; gap:12px;
}
.card{ padding:14px; border-radius:var(--radius-xl); background:rgba(255,255,255,.8); border:1px solid rgba(11,95,255,.14); box-shadow:var(--shadow-sm) }
.card .k{font-weight:800; color:#0b3aa6}
.card .v{font-weight:700}
.kv{ display:grid; grid-template-columns: 120px 1fr; gap:8px; align-items:center }
.hint{ color:var(--muted) }

/* Últimas landings & ideas */
.section{padding:30px 0}
.grid{display:grid; gap:16px}
.grid.cards{grid-template-columns: repeat(auto-fill, minmax(280px, 1fr))}
.card{padding:18px; border-radius:var(--radius-xl); background:rgba(255,255,255,.78); border:1px solid rgba(11,95,255,.14); box-shadow:var(--shadow-sm)}
.card .k{font-weight:700; font-size:12px; color:#0b3aa6}
.card .v{font-weight:600}

/* Modal Brief */
.modal{ position: fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:80; }
.modal.active{display:flex}
.modal .scrim{position:absolute; inset:0; background:rgba(2,6,23,.35); backdrop-filter: blur(6px)}
.dialog{
  position:relative; width:min(720px, 96vw); max-height:86vh; overflow:auto; padding:18px;
  border-radius:var(--radius-2xl); box-shadow:var(--shadow-lg); background:rgba(255,255,255,.9);
  border:1px solid rgba(11,95,255,.25);
}
.form-grid{display:grid; gap:12px; grid-template-columns:repeat(2, minmax(0,1fr))}
.form-grid .full{grid-column:1/-1}
.label{font-size:12px; font-weight:800; color:#0b3aa6; letter-spacing:.3px}
.input-txt, .input-num, .input-sel{
  width:100%; padding:12px 12px; border-radius:12px; border:1px solid rgba(11,95,255,.2); background:#fff; font:500 14px var(--font)
}
.colors{display:flex; gap:10px; align-items:center}
.colors .chip{width:26px; height:26px; border-radius:999px; border:1px solid rgba(2,6,23,.12)}

/* Preview modal */
.preview-modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:90; }
.preview-modal.active{display:flex}
.preview-modal .sheet{
  position:relative; width:min(1200px,96vw); height:min(86vh, 900px); background:rgba(255,255,255,.96);
  border-radius:var(--radius-2xl); border:1px solid rgba(11,95,255,.25); box-shadow:var(--shadow-lg); overflow:hidden;
  display:grid; grid-template-rows: auto 1fr;
}
.preview-modal .bar{
  display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px;
  background:linear-gradient(0deg, rgba(255,255,255,.8), rgba(255,255,255,.9));
  border-bottom:1px solid rgba(11,95,255,.15);
}
.preview-modal .actions{display:flex; gap:8px; flex-wrap:wrap}
.preview-modal iframe{ width:100%; height:100%; border:0; }
.preview-modal pre{
  display:none; margin:0; padding:14px; height:100%; overflow:auto; background:#0b1220; color:#e5e7eb;
  font: 500 12px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", "Courier New", monospace;
}
.preview-modal.show-code iframe{ display:none }
.preview-modal.show-code pre{ display:block }

/* Footer mini */
footer{ padding:24px 0 30px; color:#64748b; text-align:center }

/* Responsivo */
@media (max-width: 980px){
  .main{grid-template-columns: 1fr}
}

/* Accesibilidad simple */
:focus-visible{ outline: 2px solid rgba(14,165,233,.6); outline-offset: 2px; border-radius:8px }
</style>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <!-- NAV -->
  <div class="nav glass">
    <div class="inner container">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>PsicoFunnel</div>
        <span class="badge" id="healthBadge" title="Estado de API">● Listo</span>
      </div>
      <div class="tabs" role="tablist" aria-label="Secciones">
        <button class="tab active" role="tab" aria-selected="true">Creador</button>
        <button class="tab" role="tab" disabled title="MVP: próximamente">Leads</button>
        <button class="tab" role="tab" disabled title="MVP: próximamente">Secuencias</button>
        <button class="tab" role="tab" disabled title="MVP: próximamente">Analytics</button>
      </div>
        <div class="login"><div id="btnGoogle"></div><span class="hint" id="loginStatus">No has iniciado sesión</span></div>
    </div>
  </div>

  <!-- LOGIN MODAL -->
  <div id="loginModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="scrim" data-close-login></div>
    <div class="dialog glass" style="max-width:560px">
      <button class="btn icon" style="position:absolute; top:10px; right:10px" title="Cerrar" data-close-login aria-label="Cerrar login">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M6 6l12 12M18 6L6 18" stroke="#0b5fff" stroke-width="2" stroke-linecap="round"/></svg>
        <span>Cerrar</span>
      </button>
      <div style="display:flex; flex-direction:column; align-items:center; text-align:center; gap:14px; padding:10px 6px 2px">
        <div class="logo" aria-hidden="true"></div>
        <h2 style="margin:0; font-size:22px; letter-spacing:-.02em">Inicia sesión para continuar</h2>
        <p class="hint" style="margin:0 0 8px">Conéctate con Google para guardar tu proyecto y generar la landing.</p>
        <div id="btnGoogleModal" style="display:flex; justify-content:center"></div>
        <div class="hint" id="loginStatusModal">Tu correo no está conectado.</div>
      </div>
    </div>
  </div>

  <!-- HEADER -->
  <header class="header-hero container">
    <h1 class="title">¿Qué funnel vamos a diseñar hoy?</h1>
    <p class="subtitle">Usa el chat a continuación para describir tu landing. O elige una plantilla rápida.
      <br>Cuando estés listo, haz clic en <strong>Creamos tu funnel</strong> para completar el brief de marca.</p>

    <!-- Plantillas tipo Canva (iconos glass pequeños sin cuadrado) -->
    <div class="templates" id="templates">
      <div class="template" data-template="optin" data-sections='["hero","benefits","leadform","faq","footer"]' data-prompt="Crea una landing opt-in simple para captar emails, con un lead magnet descargable.">
        <div class="icon-glass" aria-hidden="true">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M3 7.5l9 6 9-6" stroke="#0b5fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            <rect x="3" y="6" width="18" height="12" rx="2.2" stroke="#0ea5e9" stroke-width="1.4"/>
          </svg>
        </div>
        <div class="name">Opt-in</div>
      </div>

      <div class="template" data-template="vsl" data-sections='["hero","benefits","leadform","faq","footer"]' data-prompt="Landing VSL minimalista con video central, bullets, prueba social mínima y CTA al formulario.">
        <div class="icon-glass" aria-hidden="true">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <rect x="3" y="6" width="18" height="12" rx="2.2" stroke="#0ea5e9" stroke-width="1.4"/>
            <path d="M10 9.5l5 2.5-5 2.5V9.5z" fill="#0b5fff"/>
          </svg>
        </div>
        <div class="name">VSL</div>
      </div>

      <div class="template" data-template="webinar" data-sections='["hero","benefits","leadform","faq","footer"]' data-prompt="Landing de registro a webinar con fecha/horario, bullets de valor y agenda de 3 puntos.">
        <div class="icon-glass" aria-hidden="true">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <circle cx="12" cy="12" r="9" stroke="#0ea5e9" stroke-width="1.4"/>
            <path d="M8.8 12h6.4M12 8.8v6.4" stroke="#0b5fff" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="name">Webinar</div>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="main container">
    <!-- izquierda -->
    <section class="left">
      <div class="panel glass">
        <div id="pane" class="pane" aria-live="polite" aria-label="Mensajes"></div>
        <div class="composer">
          <textarea id="composer" placeholder="Describe tu landing (objetivo, público, estilo)…"></textarea>
          <button class="btn secondary" id="openBrief" title="Creamos tu funnel (brief)"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 5v14M5 12h14" stroke="#0b5fff" stroke-width="2" stroke-linecap="round"/></svg> Creamos tu funnel</button>
          <button class="btn" id="send" aria-label="Generar"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M5 12l14-7-7 14-2-5-5-2z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> Generar</button>
        </div>
      </div>
    </section>

    <!-- derecha -->
    <aside class="right">
      <div class="panel glass">
        <div class="card">
          <div class="k">Estado</div>
          <div class="v" id="state">Listo para generar</div>
        </div>

        <div class="card">
          <div class="k">Brief (predeterminado)</div>
          <div class="kv"><div class="k">Marca</div><div class="v" id="kvBrand">—</div></div>
          <div class="kv"><div class="k">Nicho</div><div class="v" id="kvNiche">—</div></div>
          <div class="kv"><div class="k">Tono</div><div class="v" id="kvTone">—</div></div>
          <div class="kv"><div class="k">Colores</div><div class="v"><span class="colors"><span class="chip" id="kvPrimary"></span><span class="chip" id="kvAccent"></span></span></div></div>
        </div>

        <div class="card">
          <div class="k">Ayuda</div>
          <div class="hint">Describe claramente el objetivo, público y estilo. Ej: “Landing opt-in para checklist de productividad, tono profesional y minimalista, CTA ‘Recibir mi checklist’”.</div>
        </div>
      </div>
    </aside>
  </main>

  <!-- Modal Brief -->
  <div class="modal" id="briefModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="scrim" id="briefClose"></div>
    <div class="dialog glass">
      <h2 style="margin:0 0 8px">Brief de marca</h2>
      <form id="briefForm">
        <div class="form-grid">
          <div>
            <div class="label">Marca</div>
            <input class="input-txt" name="brand_name" placeholder="Ej.: PsicoFunnel">
          </div>
          <div>
            <div class="label">Nicho</div>
            <input class="input-txt" name="niche" placeholder="Ej.: coaches/cursos">
          </div>
          <div>
            <div class="label">Objetivo</div>
            <input class="input-txt" name="goal" placeholder="Ej.: captar leads">
          </div>
          <div>
            <div class="label">Tono</div>
            <input class="input-txt" name="tone" placeholder="Ej.: claro y profesional">
          </div>
          <div>
            <div class="label">Color primario</div>
            <input class="input-txt" name="color_primary" value="#0ea5e9">
          </div>
          <div>
            <div class="label">Color acento</div>
            <input class="input-txt" name="color_accent" value="#0b5fff">
          </div>
          <div>
            <div class="label">Precio (opcional)</div>
            <input class="input-num" type="number" step="1" min="0" name="offer_price" placeholder="Ej.: 49">
          </div>
          <div>
            <div class="label">Garantía (opcional)</div>
            <input class="input-txt" name="offer_guarantee" placeholder="Ej.: 7 días">
          </div>
          <div class="full">
            <div class="label">Estilo (palabras clave)</div>
            <input class="input-txt" name="style_keywords" placeholder="Ej.: liquid glass, minimalista, premium">
          </div>
        </div>
        <div style="display:flex; gap:10px; margin-top:14px">
          <button class="btn" type="submit"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M5 12l4 4L19 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>Guardar</button>
          <button class="btn secondary" id="briefReset" type="button">Reset</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Preview -->
  <div class="preview-modal" id="previewModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="scrim" id="previewClose"></div>
    <div class="sheet glass">
      <div class="bar">
        <div class="k">Preview de tu landing</div>
        <div class="actions">
          <button class="btn secondary" id="toggleCode"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M8 9l-4 3 4 3M16 9l4 3-4 3" stroke="#0b5fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> Ver código</button>
          <button class="btn secondary" id="downloadHTML"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3v12m0 0l-4-4m4 4l4-4M5 19h14" stroke="#0b5fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> Descargar</button>
          <button class="btn" id="openNewTab"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M14 4h6v6M20 4l-8 8" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> Abrir</button>
        </div>
      </div>
      <iframe id="previewFrame" title="Preview"></iframe>
      <pre id="codeBox"></pre>
    </div>
  </div>

  <section class="section container">
    <div class="grid cards" id="recentGrid"></div>
  </section>

  <footer class="container">
    <div style="display:flex; align-items:center; justify-content:center; gap:10px">
      <button id="loadDemo" class="btn secondary">Cargar prompt demo</button>
      <button id="help" class="btn secondary">Ayuda</button>
    </div>
  </footer>

<script defer>
/* =========================
   PsicoFunnel — Home MVP JS (adaptado a Webhook Make que devuelve HTML)
   ========================= */
const MAKE_URL = 'https://hook.us2.make.com/un34h9dqpi6qxcpclphk9rfav8fcvo1v'; // o '/api/psico-make-generate' si usas proxy

/* ➕ CRM endpoint + key */
const CRM_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwClYvEIqVgWa4xG93wmPJ7orZe2ryCqeKWQBfN-uoFQxaflmfn_tieoKgZyfeJPCkhLQ/exec';
const CRM_KEY = 'pon-un-secreto-simple-aqui';

/* ====== Login con Google (GSI) ====== */
const CLIENT_ID = "63285262932-aadkqkcj3c117jrj9epfvtqkaiivdl7s.apps.googleusercontent.com";
let ID_TOKEN = null;
let USER_EMAIL = null;

async function apiWhoAmI(idToken){
  const u = new URL(CRM_ENDPOINT);
  u.searchParams.set('action','whoami');
  u.searchParams.set('id_token', idToken);
  const r = await fetch(u); return r.json();
}

window.addEventListener('load', async () => {
  if (window.google && google.accounts && google.accounts.id){
    google.accounts.id.initialize({ client_id: CLIENT_ID, callback: onGoogleSignIn });
    const btn = document.getElementById('btnGoogle');
    if(btn) google.accounts.id.renderButton(btn, { theme:'outline', size:'medium', type:'standard', shape:'pill' });
    const btnM = document.getElementById('btnGoogleModal');
    if(btnM) google.accounts.id.renderButton(btnM, { theme:'filled_blue', size:'large', type:'standard', shape:'pill', text:'signin_with' });
  }
  // Reusar token si existe
  try{
    const t = localStorage.getItem('psico_id_token');
    if(t){
      const w = await apiWhoAmI(t).catch(()=>({ok:false}));
      if(w.ok){
        ID_TOKEN = t; USER_EMAIL = w.email;
        document.body.classList.add('logged');
        const ls = document.getElementById('loginStatus');
        if(ls) ls.textContent = 'Conectado: ' + USER_EMAIL;
      } else {
        localStorage.removeItem('psico_id_token'); localStorage.removeItem('psico_email');
      }
    }
  }catch(_){}
});

async function onGoogleSignIn(resp){
  ID_TOKEN = resp.credential;
  const ls = document.getElementById('loginStatus');
  if(ls) ls.textContent = 'Verificando…';
  const w = await apiWhoAmI(ID_TOKEN).catch(()=>({ok:false}));
  if(!w.ok){ if(ls) ls.textContent = w.error || 'No autorizado'; return; }
  USER_EMAIL = w.email;
  localStorage.setItem('psico_id_token', ID_TOKEN);
  localStorage.setItem('psico_email', USER_EMAIL);
  document.body.classList.add('logged');
  if(ls) ls.textContent = 'Conectado: ' + USER_EMAIL;
  const lsm = document.getElementById('loginStatusModal'); if(lsm) lsm.textContent = 'Conectado: ' + USER_EMAIL;
  setLoginModal(false);
}

const $ = (sel, el=document) => el.querySelector(sel);

/* ====== Login helpers (modal + guard) ====== */
function setLoginModal(open){
  const m = document.getElementById('loginModal');
  if(!m) return;
  m.classList.toggle('active', !!open);
  m.setAttribute('aria-hidden', open ? 'false' : 'true');
}
function ensureLogged(){
  if(ID_TOKEN) return true;
  setLoginModal(true);
  return false;
}
document.addEventListener('click', (e)=>{
  const target = e.target.closest('[data-close-login]');
  if(target) setLoginModal(false);
});

const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

const healthBadge = $('#healthBadge');
const pane = $('#pane');
const composer = $('#composer');
const sendBtn = $('#send');
const openBriefBtn = $('#openBrief');
const loadDemoBtn = $('#loadDemo');
const briefModal = $('#briefModal');
const briefForm = $('#briefForm');
const briefReset = $('#briefReset');
const recentGrid = $('#recentGrid');
const help = $('#help');

/* Preview modal elems */
const previewModal = $('#previewModal');
const previewFrame = $('#previewFrame');
const codeBox = $('#codeBox');
const toggleCodeBtn = $('#toggleCode');
const downloadBtn = $('#downloadHTML');
const openNewTabBtn = $('#openNewTab');
const previewClose = $('#previewClose');

/* Estado */
let selectedTemplate = null;
let lastHTML = '';
let lastBlobURL = '';
let RECENTS = []; // {slug, title, ts}

/* Stores */
const BriefStore = {
  key:'psico_brief',
  get(){ try{ return JSON.parse(localStorage.getItem(this.key)||'{}') }catch(_){ return {} } },
  set(v){ localStorage.setItem(this.key, JSON.stringify(v||{})); renderBriefKV(); }
};
const RecentStore = {
  key:'psico_recents',
  get(){ try{ return JSON.parse(localStorage.getItem(this.key)||'[]') }catch(_){ return [] } },
  set(v){ localStorage.setItem(this.key, JSON.stringify(v||[])) },
  push(item){ const arr=this.get(); arr.unshift(item); this.set(arr.slice(0,12)); RECENTS=arr; },
};
const SessionHTML = {
  key:'psico_html_',
  get(slug){ try{ return JSON.parse(sessionStorage.getItem(this.key+slug)||'{}') }catch(_){ return {} } },
  set(slug, obj){ sessionStorage.setItem(this.key+slug, JSON.stringify(obj||{})) }
};

/* Utils */
function addMsg(role, html){
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  div.innerHTML = html;
  pane.appendChild(div);
  pane.scrollTop = pane.scrollHeight;
  return div;
}
function setModal(open){
  briefModal.classList.toggle('active', !!open);
  briefModal.setAttribute('aria-hidden', open ? 'false' : 'true');
  if(open){ setTimeout(()=> $("[name='brand_name']", briefForm)?.focus(), 50) }
}
function setPreview(open){
  previewModal.classList.toggle('active', !!open);
  previewModal.setAttribute('aria-hidden', open ? 'false' : 'true');
}

/* Plantillas */
$('#templates').addEventListener('click', (e)=>{
  const item = e.target.closest('.template');
  if(!item) return;  if(!ID_TOKEN){ setLoginModal(true); addMsg('system','Inicia sesión para usar plantillas.'); return; }
  selectedTemplate = {
    name: item.dataset.template,
    sections: JSON.parse(item.dataset.sections||'[]'),
    prompt: item.dataset.prompt || ''
  };
  composer.value = selectedTemplate.prompt;
  addMsg('assistant', `Plantilla <strong>${selectedTemplate.name}</strong> seleccionada. Puedes editar el prompt y presionar <em>Generar</em>.`);
});

/* Brief */
openBriefBtn.addEventListener('click', ()=>{
  if(!ensureLogged()) return;
  const b = BriefStore.get();
  $$('[name]', briefForm).forEach(el=>{
    el.value = b[el.name] ?? el.value ?? '';
  });
  setModal(true);
});
briefReset.addEventListener('click', ()=>{
  localStorage.removeItem(BriefStore.key);
  $$('[name]', briefForm).forEach(el=> el.value='');
  renderBriefKV();
});
briefForm.addEventListener('submit', (e)=>{
  e.preventDefault();
  const data = Object.fromEntries(new FormData(briefForm).entries());
  if(!/^#([0-9A-Fa-f]{3}){1,2}$/.test(data.color_primary||'')) data.color_primary = '#0ea5e9';
  if(!/^#([0-9A-Fa-f]{3}){1,2}$/.test(data.color_accent||'')) data.color_accent = '#0b5fff';
  BriefStore.set(data);
  addMsg('assistant', '✅ Brief guardado. Ya podemos generar con tu marca por defecto.');
  setModal(false);
});

/* Ayuda flotante */
help.addEventListener('click', ()=> help.classList.toggle('expanded'));

/* Render recientes (sin persistir HTML por tamaño; link abre nueva pestaña si está en memoria de la sesión) */
function renderRecents(){
  const arr = RecentStore.get();
  recentGrid.innerHTML = '';
  arr.forEach(({slug, title, ts})=>{
    const {blobURL} = SessionHTML.get(slug);
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `
      <div class="k" style="margin-bottom:6px">${new Date(ts).toLocaleString()}</div>
      <div class="v" style="margin-bottom:8px">${title}</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <a class="btn secondary" href="${blobURL||'#'}" target="_blank" rel="noopener" ${blobURL?'':'aria-disabled="true"'}>Abrir</a>
        <button class="btn secondary" data-view-code="${slug}">Ver código</button>
      </div>
    `;
    recentGrid.appendChild(card);
  });
}
recentGrid.addEventListener('click', (e)=>{
  const btn = e.target.closest('[data-view-code]');
  if(!btn) return;
  const slug = btn.getAttribute('data-view-code');
  const {html} = SessionHTML.get(slug);
  if(!html){ alert('No guardamos el HTML de esa sesión.'); return; }
  previewFrame.removeAttribute('src');
  codeBox.textContent = html;
  previewModal.classList.add('show-code');
  setPreview(true);
});

/* KV brief mostrado en panel */
function validHex(s){ return /^#([0-9A-Fa-f]{3}){1,2}$/.test(s||'') }
function renderBriefKV(){
  const b = BriefStore.get();
  $('#kvBrand').textContent = b.brand_name||'—';
  $('#kvNiche').textContent = b.niche||'—';
  $('#kvTone').textContent = b.tone||'—';
  $('#kvPrimary').style.background = validHex(b.color_primary)? b.color_primary : '#0ea5e9';
  $('#kvAccent').style.background  = validHex(b.color_accent)?  b.color_accent  : '#0b5fff';
}
renderBriefKV();

/* ====== Generación ====== */
const TIMEOUT_MS = 60000;

async function sendToMake(payload){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort('timeout'), TIMEOUT_MS);
  let r;
  try{
    r = await fetch(MAKE_URL, {
      method:'POST',
      headers:{ 'Content-Type':'text/plain;charset=UTF-8', 'Accept':'text/html' },
      body: JSON.stringify(payload),
      signal: ctrl.signal
    });
  }catch(e){
    clearTimeout(t);
    if(e.name === 'AbortError') throw new Error('Timeout del servidor (60s).');
    throw new Error('No se pudo conectar: ' + e.message);
  }
  clearTimeout(t);

  const html = await r.text();
  if(!r.ok) throw new Error('Status ' + r.status + '. ' + html.slice(0,200));
  if(!/^<!doctype html/i.test(html) || !/<\/html>/i.test(html)) throw new Error('La respuesta no es un HTML completo.');
  return html;
}

/* Generación desde el chat */
async function generateFromPrompt(){
  if(!ensureLogged()){ addMsg('system','Primero inicia sesión para generar.'); return; }
  const text = composer.value.trim();
  if(!text){ composer.focus(); addMsg('system','Escribe un prompt o elige una plantilla ☝️'); return; }

  const brief = BriefStore.get() || {
    brand_name:'PsicoFunnel Demo',
    niche:'coaches/cursos',
    goal:'captar leads',
    tone:'claro y profesional',
    color_primary:'#0ea5e9',
    color_accent:'#0b5fff',
    offer_price: 49,
    offer_guarantee: 'Garantía 7 días',
    style_keywords:'liquid glass, minimalista, premium'
  };
  if(!validHex(brief.color_primary) || !validHex(brief.color_accent)){
    addMsg('system','Color inválido. Usa formato #rrggbb.'); return;
  }
  const sections = (selectedTemplate?.sections) || ["hero","benefits","leadform","faq","footer"];
  const project_slug = (brief.brand_name || 'demo')
    .toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'').slice(0,40)
    + '-' + Math.random().toString(36).slice(2,6);

  const payload = {
    project_slug,
    brand: { name: brief.brand_name || 'PsicoFunnel', colors: { primary: brief.color_primary, accent: brief.color_accent } },
    niche: brief.niche || 'general',
    goal: brief.goal || 'captar leads',
    tone: brief.tone || 'claro y profesional',
    offer: { price: brief.offer_price ? String(brief.offer_price) : undefined, guarantee: brief.offer_guarantee || undefined },
    sections,
    prompt: text,
    system2: `Eres un generador de páginas. Devuelves SIEMPRE un único archivo HTML COMPLETO (<!doctype html>…</html>) con CSS y JS inline, sin dependencias externas ni CDNs.
Debes ser minimalista, rápido (Lighthouse OK), responsive y accesible (HTML semántico, alt, aria).
Estilo: fondo blanco + acentos de color; tipografía del sistema; botones grandes.
No expliques nada fuera del HTML. No uses iframes.
NO usar fetch salvo el que viene dentro del BLOQUE CRM obligatorio.
El formulario de captura será el BLOQUE CRM obligatorio (inserta tal cual, sin cambiar NADA).`,
    lead_block_required: true
  };

  addMsg('user', text);
  const thinking = addMsg('assistant', 'Generando la landing… ⏳');

  try{
    // Registrar proyecto en CRM (asigna slug al owner)
    try{
      const reg = await fetch(CRM_ENDPOINT, {
        method:'POST',
        headers:{'Content-Type':'text/plain;charset=UTF-8'},
        body: JSON.stringify({ action:'registerProject', id_token: ID_TOKEN, project_slug })
      }).then(r=>r.json());
      if(!reg.ok){ addMsg('system', 'No pude registrar tu proyecto en el CRM: ' + (reg.error||'')); return; }
    }catch(e){ addMsg('system','Error registrando el proyecto en CRM'); return; }

    payload.owner_email = USER_EMAIL;
    payload.id_token = ID_TOKEN;

    const html = await sendToMake(payload);
    thinking.remove();

    // Guarda en memoria de sesión y en "Recientes" (metadatos)
    if(lastBlobURL) URL.revokeObjectURL(lastBlobURL);
    lastHTML = html;
    lastBlobURL = URL.createObjectURL(new Blob([html], {type:'text/html;charset=utf-8'}));
    SessionHTML.set(project_slug, {html, blobURL:lastBlobURL});
    RecentStore.push({ slug: project_slug, title: (brief.brand_name||'Marca') + ' — ' + (selectedTemplate?.name || 'custom'), ts: Date.now() });
    renderRecents();

    // Abre modal de preview
    previewFrame.removeAttribute('sandbox'); // si quieres aislar, añade sandbox con allow-scripts/allow-forms
    previewFrame.srcdoc = html;
    codeBox.textContent = html;
    previewModal.classList.remove('show-code');
    setPreview(true);

    addMsg('assistant', `Listo ✅ Abre la preview para ver/descargar tu landing.`);

    composer.value=''; selectedTemplate = null;
  }catch(err){
    thinking.remove();
    console.error(err);
    addMsg('system', 'Error: ' + (err.message||String(err)));
  }
}

/* Eventos del chat */
sendBtn.addEventListener('click', generateFromPrompt);
composer.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); generateFromPrompt(); }
});

/* Demo rápida */
loadDemoBtn.addEventListener('click', ()=>{
  composer.value = "Crea una landing opt-in para un checklist de productividad dirigido a freelancers. Estilo minimalista, premium, con efecto liquid glass, tonos azul/celeste, copy profesional, sin promesas vacías. CTA a ‘Recibir mi checklist’.";
  addMsg('assistant','Cargué un prompt de ejemplo. ¡Dale a Generar!');
});

/* Preview modal actions */
toggleCodeBtn.addEventListener('click', ()=> previewModal.classList.toggle('show-code'));
downloadBtn.addEventListener('click', ()=>{
  if(!lastHTML){ return }
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([lastHTML], {type:'text/html;charset=utf-8'}));
  a.download = 'landing.html';
  a.click();
});
openNewTabBtn.addEventListener('click', ()=>{
  if(!lastBlobURL) return;
  window.open(lastBlobURL, '_blank', 'noopener');
});
previewClose.addEventListener('click', ()=> setPreview(false));

/* Salud (ping simple al endpoint CRM) */
(async ()=>{
  try{
    const u = new URL(CRM_ENDPOINT); u.searchParams.set('action','ping');
    const r = await fetch(u, {method:'GET'}); if(!r.ok) throw 0;
    healthBadge.textContent = '● Online';
    healthBadge.style.color = 'green';
  }catch(_){
    healthBadge.textContent = '● Offline';
    healthBadge.style.color = '#b91c1c';
  }
})();
</script>
</body>
</html>
