<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>POC PsicoFunnel → Make → GPT</title>
<style>
  :root{--b:#0b1220;--m:#64748b;--br:#e5e7eb}
  body{font:15px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial;margin:0;background:#f7f9fc;color:var(--b)}
  .wrap{max-width:960px;margin:24px auto;padding:0 16px}
  .card{background:#fff;border:1px solid var(--br);border-radius:12px;box-shadow:0 6px 16px rgba(2,6,23,.06);padding:14px;margin-bottom:16px}
  h1{margin:8px 0 12px;font-size:20px}
  label{display:block;font-weight:800;font-size:12px;color:#0b3aa6;margin:8px 0 4px}
  input,textarea,button{font:inherit}
  input,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #d5def0;background:#fff}
  textarea{min-height:110px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .btn{display:inline-block;padding:12px 16px;border-radius:12px;border:0;cursor:pointer;font-weight:800;background:#0b5fff;color:#fff}
  .btn.ghost{background:#fff;color:#0b3aa6;border:1px solid #abc4ff}
  .hint{color:var(--m);font-size:13px}
  iframe{width:100%;height:70vh;border:1px solid var(--br);border-radius:12px;background:#fff}
  pre{white-space:pre-wrap;max-height:320px;overflow:auto;background:#f6f8fa;padding:10px;border-radius:8px;border:1px solid var(--br)}
  .bar{display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Generar landing con Make + GPT</h1>
    <p class="hint">Completa el brief y prompt → “Generar”. Asegúrate de tener el escenario en Make en <strong>Run once</strong>.</p>

    <div class="grid2">
      <div>
        <label>Marca</label>
        <input id="brand_name" value="PsicoFunnel" />
      </div>
      <div>
        <label>Nicho</label>
        <input id="niche" value="coaches" />
      </div>
      <div>
        <label>Objetivo</label>
        <input id="goal" value="captar leads" />
      </div>
      <div>
        <label>Tono</label>
        <input id="tone" value="claro y profesional" />
      </div>
      <div>
        <label>Color primario (HEX)</label>
        <input id="color_primary" value="#0ea5e9" />
      </div>
      <div>
        <label>Color acento (HEX)</label>
        <input id="color_accent" value="#0b5fff" />
      </div>
      <div>
        <label>Precio (opcional)</label>
        <input id="offer_price" type="number" step="1" placeholder="49" />
      </div>
      <div>
        <label>Garantía (opcional)</label>
        <input id="offer_guarantee" placeholder="Garantía 7 días" />
      </div>
    </div>

    <label style="margin-top:8px">Prompt</label>
    <textarea id="prompt">Crea una landing opt-in con hero fuerte, 3 beneficios, formulario de email y FAQ. CTA: “Recibir mi checklist”.</textarea>

    <div class="bar">
      <button class="btn" id="gen">Generar</button>
      <button class="btn ghost" id="genQuick">Generar rápido (brief mínimo)</button>
      <span class="hint" id="status"></span>
    </div>
  </div>

  <div class="card">
    <h3>Preview</h3>
    <iframe id="preview" title="Preview"></iframe>
    <details style="margin-top:10px">
      <summary><strong>Ver código (index.html)</strong></summary>
      <pre id="code"></pre>
    </details>
  </div>
</div>

<script>
const MAKE_URL = "https://hook.us2.make.com/un34h9dqpi6qxcpclphk9rfav8fcvo1v"; // ← TU WEBHOOK
const $ = id => document.getElementById(id);
const statusEl = $('status'), preview = $('preview'), codeBox = $('code');

function makeSlug(base){
  const s = (base || 'demo').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'').slice(0,40);
  return s + '-' + Math.random().toString(36).slice(2,6);
}

function buildPayload(full=true){
  const slug = makeSlug($('brand_name').value);
  if(!full){
    return {
      project_slug: slug,
      brand: { name: $('brand_name').value || 'PsicoFunnel',
               colors: { primary: $('color_primary').value || '#0ea5e9',
                         accent: $('color_accent').value || '#0b5fff' } },
      goal: 'captar leads',
      tone: 'claro y profesional',
      sections: ["hero","leadform","footer"],
      prompt: 'Landing simple de prueba'
    };
  }
  return {
    project_slug: slug,
    brand: {
      name: $('brand_name').value || 'PsicoFunnel',
      colors: { primary: $('color_primary').value || '#0ea5e9', accent: $('color_accent').value || '#0b5fff' }
    },
    niche: $('niche').value || 'general',
    goal: $('goal').value || 'captar leads',
    tone: $('tone').value || 'claro y profesional',
    offer: {
      price: $('offer_price').value ? Number($('offer_price').value) : undefined,
      guarantee: $('offer_guarantee').value || undefined
    },
    // Si quieres forzar orden de secciones, puedes agregar: sections: [...]
    prompt: $('prompt').value.trim()
  };
}

async function sendToMake(payload){
  statusEl.textContent = 'Enviando a Make…';
  codeBox.textContent = '';
  preview.removeAttribute('srcdoc');

  const r = await fetch(MAKE_URL, {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify(payload)
  });

  // Make debe responder JSON: { ok: true, index_html: "<!doctype html>..." }
  const text = await r.text();
  let j;
  try { j = JSON.parse(text); } catch(e){ throw new Error('Respuesta no es JSON. Recibido: ' + text.slice(0,200)); }
  if(!j.ok) throw new Error(j.error || 'Respuesta no OK del webhook');

  const html = j.index_html;
  if(!html || !html.includes('<html')) throw new Error('No vino HTML válido en index_html.');
  codeBox.textContent = html;
  preview.srcdoc = html;
  statusEl.textContent = 'Listo ✔';
}

$('gen').onclick = async ()=>{
  try{ await sendToMake(buildPayload(true)); }
  catch(e){ statusEl.textContent = 'Error: ' + (e.message || e); }
};

$('genQuick').onclick = async ()=>{
  try{ await sendToMake(buildPayload(false)); }
  catch(e){ statusEl.textContent = 'Error: ' + (e.message || e); }
};
</script>
</body>
</html>
