<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>PsicoFunnel — Creador (MVP)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="color-scheme" content="light">
<style>
/* =========================
   PsicoFunnel — Home MVP
   Estética: blanco predominante + liquid glass + acentos azul
   ========================= */
:root{
  /* Tema */
  --bg:#f7f9fc;                 /* blanco suave */
  --bg-grad: radial-gradient(1200px 800px at 20% -10%, #eaf2ff 0%, rgba(234,242,255,0) 60%),
             radial-gradient(900px 700px at 100% 0%, #f0fbff 0%, rgba(240,251,255,0) 60%);
  --card: rgba(255,255,255,.62);
  --border: rgba(255,255,255,.38);
  --text:#0b1220;               /* navy muy oscuro */
  --muted:#6b7280;
  --primary:#0ea5e9;            /* celeste */
  --accent:#0b5fff;             /* azul */
  --success:#10b981;
  --warn:#f59e0b;
  --danger:#ef4444;
  --glass-blur: 18px;
  --radius-2xl: 24px;
  --radius-xl: 18px;
  --radius-lg: 14px;
  --shadow-lg: 0 20px 60px rgba(15,23,42,.12);
  --shadow-md: 0 10px 30px rgba(2,6,23,.10);
  --shadow-sm: 0 6px 16px rgba(2,6,23,.08);
  --ring: 0 0 0 8px rgba(14,165,233,.15);
  --ring-strong: 0 0 0 10px rgba(14,165,233,.22);

  /* Tipografía */
  --font: Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;

  /* Dimensiones */
  --nav-h: 68px;
  --max-w: 1180px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  font-family:var(--font);
  color:var(--text);
  background: var(--bg);
  background-image: var(--bg-grad);
  background-attachment: fixed;
}

/* Utilidades */
.container{max-width:var(--max-w); margin:0 auto; padding:0 20px}
.glass{
  background:var(--card);
  border:1px solid var(--border);
  backdrop-filter:saturate(1.35) blur(var(--glass-blur));
  -webkit-backdrop-filter:saturate(1.35) blur(var(--glass-blur));
  border-radius:var(--radius-2xl);
  box-shadow:var(--shadow-lg);
}
.btn{
  display:inline-flex; align-items:center; gap:10px;
  padding:14px 20px; border-radius:999px; border:0; cursor:pointer;
  background:linear-gradient(135deg,var(--accent),var(--primary));
  color:#fff; font-weight:700; letter-spacing:.2px; text-decoration:none;
  box-shadow:0 12px 28px rgba(14,165,233,.35);
  transition:transform .15s ease, box-shadow .2s ease, filter .2s ease;
}
.btn:hover{transform:translateY(-1px); filter:saturate(1.1)}
.btn:active{transform:translateY(0); box-shadow:0 10px 20px rgba(14,165,233,.3)}
.btn.ghost{
  background:transparent; color:var(--accent); border:1px solid rgba(11,95,255,.25);
  box-shadow:var(--shadow-sm);
}
.badge{
  display:inline-flex; align-items:center; gap:8px;
  padding:6px 12px; border-radius:999px;
  background:rgba(14,165,233,.12); color:var(--accent); font-weight:700; font-size:12px;
  border:1px solid rgba(11,95,255,.25);
}
.pills{display:flex; gap:8px; flex-wrap:wrap}
.pill{
  padding:8px 12px; border-radius:999px; border:1px solid rgba(11,95,255,.18);
  background:rgba(255,255,255,.6); color:#0b3aa6; font-weight:600; cursor:pointer;
  transition:transform .1s ease, background .2s ease;
}
.pill:hover{transform:translateY(-1px); background:#fff}
.hint{color:var(--muted); font-size:14px}
hr.sep{border:0;height:1px;background:linear-gradient(90deg,rgba(11,95,255,.18),rgba(14,165,233,.18)); margin:28px 0}

/* Nav superior */
.nav{
  position:sticky; top:0; z-index:50; height:var(--nav-h);
  display:flex; align-items:center; backdrop-filter:saturate(1.2) blur(14px);
  -webkit-backdrop-filter:saturate(1.2) blur(14px);
  border-bottom:1px solid rgba(11,95,255,.08);
}
.nav .inner{display:flex; align-items:center; justify-content:space-between}
.brand{ display:flex; align-items:center; gap:12px; font-weight:900; letter-spacing:.2px; }
.brand .logo{
  width:36px; height:36px; border-radius:14px;
  background:linear-gradient(135deg,#0b5fff 0%, #0ea5e9 100%);
  box-shadow:0 10px 30px rgba(11,95,255,.28), inset 0 0 20px rgba(255,255,255,.35);
  position:relative; overflow:hidden;
}
.brand .logo::after{
  content:""; position:absolute; inset:-40% -20% auto auto; width:120%; height:120%;
  background:linear-gradient(60deg,rgba(255,255,255,.55),rgba(255,255,255,0));
  transform:rotate(12deg);
}
.nav .tabs{display:flex; gap:8px; align-items:center}
.tab{
  padding:10px 14px; border-radius:999px; font-weight:700; font-size:14px;
  background:rgba(255,255,255,.7); border:1px solid rgba(11,95,255,.15); cursor:pointer;
}
.tab.active{background:linear-gradient(135deg,rgba(11,95,255,.15), rgba(14,165,233,.15)); color:#0b3aa6}

/* Header pregunta + CTA */
.header-hero{ padding:34px 0 18px; text-align:center; }
.title{
  font-size: clamp(28px, 4vw, 44px);
  line-height:1.05; font-weight:900; letter-spacing:-.02em; margin:10px 0 8px;
  background:linear-gradient(120deg,#0b5fff 0%,#0ea5e9 35%,#0b5fff 70%);
  -webkit-background-clip:text; background-clip:text; color:transparent;
  position:relative; display:inline-block;
}
.title::after{
  content:""; display:block; height:8px; border-radius:999px; margin:10px auto 0;
  width:58%; background:linear-gradient(90deg,rgba(11,95,255,.45),rgba(14,165,233,.35)); filter: blur(2px);
}
.header-hero .subtitle{color:var(--muted); max-width:780px; margin:8px auto 0}

/* Plantillas (iconos glass pequeños, sin cuadrado) */
.templates{
  margin-top:18px; display:flex; justify-content:center; gap:18px; flex-wrap:wrap;
}
.template{ display:flex; flex-direction:column; align-items:center; gap:10px; width:96px; cursor:pointer; user-select:none; }
.icon-glass{
  width:68px; height:68px; border-radius:50%;
  background: radial-gradient(120% 120% at 30% 20%, rgba(255,255,255,.9) 0%, rgba(255,255,255,.55) 45%, rgba(255,255,255,.35) 100%),
              linear-gradient(135deg, rgba(11,95,255,.18), rgba(14,165,233,.18));
  border:1px solid rgba(11,95,255,.25);
  backdrop-filter:saturate(1.35) blur(12px); -webkit-backdrop-filter:saturate(1.35) blur(12px);
  box-shadow: var(--shadow-md), inset 0 1px 0 rgba(255,255,255,.6);
  display:grid; place-items:center;
  transition: transform .15s ease, box-shadow .2s ease, border-color .2s ease;
}
.icon-glass:hover{ transform: translateY(-2px); box-shadow: var(--shadow-lg); border-color: rgba(11,95,255,.35) }
.template .name{font-size:12px; font-weight:700; color:#0b3aa6; text-align:center}

/* Chat canvas */
.canvas{ min-height: calc(100vh - var(--nav-h) - 176px); display:grid; place-items:stretch; margin-top:10px; }
.chat{
  position:relative; overflow:hidden; border-radius:var(--radius-2xl);
  padding:0; display:grid; grid-template-rows: 1fr auto; height:72vh;
}
.chat .bg{ position:absolute; inset:0; pointer-events:none;
  background: radial-gradient(800px 600px at 15% 20%, rgba(11,95,255,.12), transparent 60%),
              radial-gradient(700px 600px at 85% 10%, rgba(14,165,233,.10), transparent 60%),
              radial-gradient(900px 700px at 50% 100%, rgba(11,95,255,.10), transparent 60%); }
.chat .surface{ position:absolute; inset:0; padding:18px; display:flex; flex-direction:column; }
.chat .pane{ flex:1; overflow:auto; padding:8px; display:flex; flex-direction:column; gap:10px; }
.msg{
  max-width:68ch; padding:12px 14px; border-radius:16px; box-shadow:var(--shadow-sm);
  border:1px solid rgba(11,95,255,.12); background:#fff; line-height:1.35;
}
.msg.user{ align-self:flex-end; background:linear-gradient(135deg, #ffffff, #f6fbff); border-color:rgba(14,165,233,.25) }
.msg.assistant{ align-self:flex-start }
.msg.system{ align-self:center; font-size:13px; color:var(--muted); background:rgba(255,255,255,.6) }

.composer{
  display:flex; gap:10px; padding:10px; border-top:1px solid rgba(11,95,255,.1);
  background:rgba(255,255,255,.75); backdrop-filter: blur(8px);
  border-bottom-left-radius:var(--radius-2xl); border-bottom-right-radius:var(--radius-2xl);
}
.input{ flex:1; display:flex; align-items:center; gap:8px; padding:10px 12px;
  background:#fff; border:1px solid rgba(11,95,255,.18); border-radius:14px; box-shadow: inset 0 1px 0 rgba(255,255,255,.7); }
.input textarea{ width:100%; border:0; outline:0; resize:none; max-height:180px; font: 500 15px/1.4 var(--font); color:var(--text); }
.chips{display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 0}
.chip{ padding:6px 10px; border-radius:999px; background:rgba(14,165,233,.12);
  border:1px solid rgba(11,95,255,.25); color:#0b3aa6; font-weight:700; font-size:12px; cursor:pointer; }

/* Últimas landings & ideas */
.section{padding:30px 0}
.grid{display:grid; gap:16px}
.grid.cards{grid-template-columns: repeat(auto-fill, minmax(280px, 1fr))}
.card{padding:18px; border-radius:var(--radius-xl); background:rgba(255,255,255,.78); border:1px solid rgba(11,95,255,.14); box-shadow:var(--shadow-sm)}
.card .k{font-weight:700; font-size:12px; color:#0b3aa6}
.card .v{font-weight:600}

/* Modal Brief */
.modal{ position: fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:80; }
.modal.active{display:flex}
.modal .scrim{position:absolute; inset:0; background:rgba(2,6,23,.35); backdrop-filter: blur(6px)}
.dialog{
  position:relative; width:min(720px, 96vw); max-height:86vh; overflow:auto; padding:18px;
  border-radius:var(--radius-2xl); box-shadow:var(--shadow-lg); background:rgba(255,255,255,.9);
  border:1px solid rgba(11,95,255,.25);
}
.form-grid{display:grid; gap:12px; grid-template-columns:repeat(2, minmax(0,1fr))}
.form-grid .full{grid-column:1/-1}
.label{font-size:12px; font-weight:800; color:#0b3aa6; letter-spacing:.3px}
.input-txt, .input-num, .input-sel{
  width:100%; padding:12px 12px; border-radius:12px; border:1px solid rgba(11,95,255,.2); background:#fff; font:500 14px var(--font)
}
.colors{display:flex; gap:10px}
.colors input[type=color]{appearance:none; width:44px; height:36px; border-radius:12px; border:1px solid rgba(11,95,255,.25); padding:0}

/* Modal Preview (iframe + código) */
.preview-modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:90; }
.preview-modal.active{display:flex}
.preview-modal .sheet{
  position:relative; width:min(1200px,96vw); height:min(86vh, 900px); background:rgba(255,255,255,.96);
  border-radius:var(--radius-2xl); border:1px solid rgba(11,95,255,.25); box-shadow:var(--shadow-lg); overflow:hidden;
  display:grid; grid-template-rows: auto 1fr;
}
.preview-modal .bar{
  display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px;
  background:linear-gradient(0deg, rgba(255,255,255,.8), rgba(255,255,255,.9));
  border-bottom:1px solid rgba(11,95,255,.15);
}
.preview-modal .actions{display:flex; gap:8px; flex-wrap:wrap}
.preview-modal iframe{ width:100%; height:100%; border:0; }
.preview-modal pre{
  display:none; margin:0; padding:14px; height:100%; overflow:auto; background:#0b1220; color:#e5e7eb;
  font: 12px/1.5 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
}
.preview-modal.show-code iframe{display:none}
.preview-modal.show-code pre{display:block}
</style>
</head>
<body>
  <!-- NAV -->
  <div class="nav glass">
    <div class="inner container">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>PsicoFunnel</div>
        <span class="badge" id="healthBadge" title="Estado de API">● Listo</span>
      </div>
      <div class="tabs" role="tablist" aria-label="Secciones">
        <button class="tab active" role="tab" aria-selected="true">Creador</button>
        <button class="tab" role="tab" disabled title="MVP: próximamente">Leads</button>
        <button class="tab" role="tab" disabled title="MVP: próximamente">Secuencias</button>
        <button class="tab" role="tab" disabled title="MVP: próximamente">Analytics</button>
      </div>
    </div>
  </div>

  <!-- HEADER -->
  <header class="header-hero container">
    <h1 class="title">¿Qué funnel vamos a diseñar hoy?</h1>
    <p class="subtitle">Usa el chat a continuación para describir tu landing. O elige una plantilla rápida.
      <br>Cuando estés listo, haz clic en <strong>Creamos tu funnel</strong> para completar el brief de marca.</p>

    <!-- Plantillas tipo Canva (iconos glass pequeños sin cuadrado) -->
    <div class="templates" id="templates">
      <div class="template" data-template="optin" data-sections='["hero","benefits","leadform","faq","footer"]' data-prompt="Crea una landing opt-in simple para captar emails, con un lead magnet descargable.">
        <div class="icon-glass" aria-hidden="true">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M3 7.5l9 6 9-6" stroke="#0b5fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            <rect x="3" y="6" width="18" height="12" rx="2.2" stroke="#0ea5e9" stroke-width="1.4"/>
          </svg>
        </div>
        <div class="name">Opt-in</div>
      </div>

      <div class="template" data-template="vsl" data-sections='["hero","how","leadform","pricing","faq","footer"]' data-prompt="Crea una página VSL con un video central, bullets, prueba social mínima y CTA al formulario.">
        <div class="icon-glass" aria-hidden="true">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <rect x="3" y="6" width="18" height="12" rx="2.2" stroke="#0ea5e9" stroke-width="1.4"/>
            <path d="M10 9.5l5 2.5-5 2.5V9.5z" fill="#0b5fff"/>
          </svg>
        </div>
        <div class="name">VSL</div>
      </div>

      <div class="template" data-template="webinar" data-sections='["hero","steps","leadform","faq","footer"]' data-prompt="Crea registro a webinar con fecha/horario, bullets de valor y agenda de 3 puntos.">
        <div class="icon-glass" aria-hidden="true">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <rect x="3" y="5" width="18" height="14" rx="2.2" stroke="#0ea5e9" stroke-width="1.4"/>
            <path d="M3 9h18" stroke="#0b5fff" stroke-width="1.4"/>
            <circle cx="9" cy="13" r="1.4" fill="#0b5fff"/><circle cx="15" cy="13" r="1.4" fill="#0ea5e9"/>
          </svg>
        </div>
        <div class="name">Webinar</div>
      </div>

      <div class="template" data-template="checkout" data-sections='["hero","pricing","faq","footer"]' data-prompt="Crea una página de checkout simple con beneficios y garantía breve.">
        <div class="icon-glass" aria-hidden="true">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M4 6h2l2 10h8l2-7H7" stroke="#0b5fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="10" cy="19" r="1.5" fill="#0ea5e9"/><circle cx="16" cy="19" r="1.5" fill="#0ea5e9"/>
          </svg>
        </div>
        <div class="name">Checkout</div>
      </div>

      <div class="template" data-template="thanks" data-sections='["hero","how","footer"]' data-prompt="Crea una página de gracias con próximos pasos claros.">
        <div class="icon-glass" aria-hidden="true">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <circle cx="12" cy="12" r="9" stroke="#0ea5e9" stroke-width="1.4"/>
            <path d="M8.5 12.5l2.5 2.5 4.5-5.5" stroke="#0b5fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="name">Thank You</div>
      </div>

      <div class="template" data-template="sales" data-sections='["hero","benefits","how","pricing","faq","footer"]' data-prompt="Crea una sales page breve con beneficios, cómo funciona, precio y FAQ.">
        <div class="icon-glass" aria-hidden="true">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 3l8 8-7 7-8-8V3h7z" stroke="#0b5fff" stroke-width="1.6" stroke-linejoin="round"/>
            <circle cx="10" cy="8" r="1.4" fill="#0ea5e9"/>
          </svg>
        </div>
        <div class="name">Sales Page</div>
      </div>
    </div>

    <div style="margin-top:16px; display:flex; gap:10px; justify-content:center;">
      <button class="btn" id="openBrief">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 5v14M5 12h14" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
        Creamos tu funnel
      </button>
      <button class="btn ghost" id="loadDemo">Cargar demo rápida</button>
    </div>
  </header>

  <!-- CHAT CANVAS -->
  <main class="container canvas">
    <section class="chat glass" aria-label="Creador tipo chat">
      <div class="bg" aria-hidden="true"></div>
      <div class="surface">
        <div id="pane" class="pane" role="log" aria-live="polite" aria-label="Mensajes del chat">
          <div class="msg system">Consejo: selecciona una plantilla arriba para autocompletar el prompt o escribe libremente.</div>
        </div>
        <div class="composer">
          <div class="input" style="flex:1">
            <textarea id="composer" rows="1" placeholder="Describe tu funnel… (Shift+Enter para salto de línea)"></textarea>
          </div>
          <button class="btn" id="send" aria-label="Enviar prompt y generar">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 12l16-8-7 16-2-7-7-1z" stroke="white" stroke-width="2" stroke-linejoin="round"/></svg>
            Generar
          </button>
        </div>
        <div class="chips" id="chips">
          <div class="chip">Añade FAQ</div>
          <div class="chip">Incluye garantía 7 días</div>
          <div class="chip">Tono profesional y claro</div>
          <div class="chip">CTA con beneficio</div>
        </div>
      </div>
    </section>
  </main>

  <!-- ÚLTIMAS LANDINGS + IDEAS -->
  <section class="container section" id="recentSection">
    <h3 style="margin:0 0 10px; font-size:20px">Últimas landings generadas</h3>
    <div class="grid cards" id="recentGrid" aria-live="polite"></div>
    <hr class="sep">
    <h3 style="margin:0 0 10px; font-size:20px">Ideas y plantillas recomendadas</h3>
    <div class="grid cards" id="ideasGrid">
      <div class="card"><div class="k">Opt-in con lead magnet</div><div class="hint">Ebook, checklist o mini-curso. Conversión esperada 3-7% con tráfico templado.</div></div>
      <div class="card"><div class="k">VSL con CTA a agenda</div><div class="hint">Video 3-7 min + prueba social breve. Ideal coaches/agencias.</div></div>
      <div class="card"><div class="k">Webinar evergreen</div><div class="hint">Registro + confirmación + replay. Secuencia 0/60/120s.</div></div>
      <div class="card"><div class="k">Checkout + garantía</div><div class="hint">Precio claro, bullets de valor, preguntas frecuentes.</div></div>
    </div>
  </section>

  <!-- MODAL BRIEF -->
  <div class="modal" id="briefModal" aria-hidden="true" aria-labelledby="briefTitle" role="dialog">
    <div class="scrim" data-close></div>
    <div class="dialog">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px">
        <div>
          <div class="badge">Brief de marca</div>
          <h2 id="briefTitle" style="margin:8px 0 2px">Completemos tu brief</h2>
          <div class="hint">Estos datos se usarán como default al generar tu funnel.</div>
        </div>
        <button class="btn ghost" data-close aria-label="Cerrar">Cerrar</button>
      </div>

      <form id="briefForm" class="form-grid">
        <div>
          <label class="label">Nombre de marca</label>
          <input class="input-txt" name="brand_name" required placeholder="Ej. PsicoFunnel">
        </div>
        <div>
          <label class="label">Nicho</label>
          <input class="input-txt" name="niche" placeholder="Ej. Coaching de hábitos">
        </div>

        <div>
          <label class="label">Objetivo</label>
          <input class="input-txt" name="goal" placeholder="Ej. Captar leads para sesión diagnóstica">
        </div>
        <div>
          <label class="label">Tono</label>
          <input class="input-txt" name="tone" placeholder="Ej. Positivo, claro, sin promesas vacías">
        </div>

        <div class="full colors">
          <div style="flex:1">
            <label class="label">Color primario</label>
            <input type="color" name="color_primary" value="#0ea5e9">
          </div>
          <div style="flex:1">
            <label class="label">Color acento</label>
            <input type="color" name="color_accent" value="#0b5fff">
          </div>
          <div style="flex:2">
            <label class="label">Estilo / keywords</label>
            <input class="input-txt" name="style_keywords" placeholder="liquid glass, minimalista, premium">
          </div>
        </div>

        <div>
          <label class="label">Precio (opcional)</label>
          <input class="input-num" type="number" min="0" step="1" name="offer_price" placeholder="49">
        </div>
        <div>
          <label class="label">Garantía (opcional)</label>
          <input class="input-txt" name="offer_guarantee" placeholder="Garantía 7 días">
        </div>

        <div class="full" style="display:flex; gap:10px; justify-content:flex-end; margin-top:6px">
          <button type="button" class="btn ghost" id="briefReset">Reset</button>
          <button type="submit" class="btn">Guardar brief</button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL PREVIEW (iframe + código + descarga) -->
  <div class="preview-modal" id="previewModal" aria-hidden="true" role="dialog">
    <div class="sheet">
      <div class="bar">
        <div class="pills">
          <span class="pill">Preview</span>
          <span class="pill" id="toggleCode">Ver código</span>
        </div>
        <div class="actions">
          <button class="btn ghost" id="downloadHTML">Descargar HTML</button>
          <button class="btn ghost" id="openNewTab">Abrir en pestaña</button>
          <button class="btn" id="closePreview">Cerrar</button>
        </div>
      </div>
      <iframe id="previewFrame" title="Vista previa de la landing"></iframe>
      <pre id="codeBox"></pre>
    </div>
  </div>

  <!-- HELP BUBBLE -->
  <div class="help" id="help">
    <div class="bubble" title="Ayuda" aria-label="Abrir ayuda">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M12 17h.01" stroke="white" stroke-width="2" stroke-linecap="round"/>
        <path d="M9.1 9.5a3.1 3.1 0 016.01.9c0 2-2.1 2.4-2.1 3.6" stroke="white" stroke-width="2" stroke-linecap="round"/>
        <circle cx="12" cy="12" r="9" stroke="white" stroke-width="1.5" opacity=".7"/>
      </svg>
    </div>
    <div class="panel">
      <div class="card glass">
        <div class="k">Tips rápidos</div>
        <ul class="hint" style="margin:8px 0 0; padding-left:18px">
          <li>Elige una plantilla para autocompletar el prompt.</li>
          <li>Click en <strong>Creamos tu funnel</strong> para guardar tu brief.</li>
          <li>Tras generar, podrás previsualizar, descargar o abrir la landing.</li>
        </ul>
      </div>
    </div>
  </div>

<script defer>
/* =========================
   PsicoFunnel — Home MVP JS (adaptado a Webhook Make que devuelve HTML)
   ========================= */
const MAKE_URL = 'https://hook.us2.make.com/un34h9dqpi6qxcpclphk9rfav8fcvo1v'; // o '/api/psico-make-generate' si usas proxy

const $ = (sel, el=document) => el.querySelector(sel);
const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

const healthBadge = $('#healthBadge');
const pane = $('#pane');
const composer = $('#composer');
const sendBtn = $('#send');
const openBriefBtn = $('#openBrief');
const loadDemoBtn = $('#loadDemo');
const briefModal = $('#briefModal');
const briefForm = $('#briefForm');
const briefReset = $('#briefReset');
const recentGrid = $('#recentGrid');
const help = $('#help');

/* Preview modal elems */
const previewModal = $('#previewModal');
const previewFrame = $('#previewFrame');
const codeBox = $('#codeBox');
const toggleCodeBtn = $('#toggleCode');
const downloadBtn = $('#downloadHTML');
const openTabBtn = $('#openNewTab');
const closePreviewBtn = $('#closePreview');

let selectedTemplate = null;
let lastHTML = '';   // guarda el último HTML generado en memoria (para descarga/abrir)
let lastBlobURL = ''; // object URL para abrir en pestaña

/* Estado local: brief + recientes (solo metadatos) */
const BriefStore = {
  key: 'pf_brief_v1',
  get(){ try { return JSON.parse(localStorage.getItem(this.key)||'null') } catch { return null } },
  set(data){ localStorage.setItem(this.key, JSON.stringify(data||{})); },
  reset(){ localStorage.removeItem(this.key); }
};
const RecentStore = {
  key: 'pf_recent_sites_v1',
  list(){ try { return JSON.parse(localStorage.getItem(this.key)||'[]') } catch { return [] } },
  push(item){ const arr = this.list(); arr.unshift(item); localStorage.setItem(this.key, JSON.stringify(arr.slice(0,12))); }
};

/* Salud simple (solo texto) */
healthBadge.textContent = '● Listo';
healthBadge.style.color = 'var(--success)';
healthBadge.title = 'Webhook configurado';

/* Utilidades UI */
function addMsg(role, html){
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  div.innerHTML = html;
  pane.appendChild(div);
  pane.scrollTop = pane.scrollHeight;
  return div;
}
function setModal(open){
  briefModal.classList.toggle('active', !!open);
  briefModal.setAttribute('aria-hidden', open ? 'false' : 'true');
  if(open){ setTimeout(()=> $("[name='brand_name']", briefForm)?.focus(), 50) }
}
function setPreview(open){
  previewModal.classList.toggle('active', !!open);
  previewModal.setAttribute('aria-hidden', open ? 'false' : 'true');
}

/* Plantillas */
$('#templates').addEventListener('click', (e)=>{
  const item = e.target.closest('.template');
  if(!item) return;
  selectedTemplate = {
    name: item.dataset.template,
    sections: JSON.parse(item.dataset.sections||'[]'),
    prompt: item.dataset.prompt || ''
  };
  composer.value = selectedTemplate.prompt;
  addMsg('assistant', `Plantilla <strong>${selectedTemplate.name}</strong> seleccionada. Puedes editar el prompt y presionar <em>Generar</em>.`);
});

/* Chips: autocompletar */
$('#chips').addEventListener('click', (e)=>{
  const chip = e.target.closest('.chip');
  if(!chip) return;
  const add = chip.textContent.trim();
  const cur = composer.value.trim();
  composer.value = cur ? cur + (cur.endsWith('.')?'':'') + ' ' + add + '.' : add + '.';
  composer.focus();
});

/* Brief modal */
openBriefBtn.addEventListener('click', ()=>{
  const saved = BriefStore.get() || {};
  $$('[name]', briefForm).forEach(inp=>{
    const k = inp.name; if(saved[k] != null) inp.value = saved[k];
  });
  setModal(true);
});
briefReset.addEventListener('click', ()=>{ BriefStore.reset(); $$('[name]', briefForm).forEach(inp=> inp.value = ''); });
briefForm.addEventListener('submit', (e)=>{
  e.preventDefault();
  const data = Object.fromEntries(new FormData(briefForm).entries());
  if(!/^#([0-9A-Fa-f]{3}){1,2}$/.test(data.color_primary||'')) data.color_primary = '#0ea5e9';
  if(!/^#([0-9A-Fa-f]{3}){1,2}$/.test(data.color_accent||'')) data.color_accent = '#0b5fff';
  BriefStore.set(data);
  addMsg('assistant', '✅ Brief guardado. Ya podemos generar con tu marca por defecto.');
  setModal(false);
});

/* Ayuda flotante */
help.addEventListener('click', ()=> help.classList.toggle('expanded'));

/* Render recientes (sin persistir HTML por tamaño; link abre nueva pestaña si está en memoria de la sesión) */
function renderRecents(){
  const arr = RecentStore.list();
  recentGrid.innerHTML = '';
  if(!arr.length){
    recentGrid.innerHTML = `<div class="card"><div class="k">Aún no hay landings</div><div class="hint">Cuando generes tu primera landing, aparecerá aquí.</div></div>`;
    return;
  }
  arr.forEach(it=>{
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="k">${it.title || 'Landing generada'}</div>
      <div class="hint" style="margin:6px 0 10px">Slug: <strong>${it.slug}</strong> • Fecha: ${new Date(it.ts).toLocaleString()}</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn" data-open="${it.slug}">Abrir</button>
        <button class="btn ghost" data-copy="${it.slug}">Copiar código</button>
      </div>`;
    recentGrid.appendChild(card);
  });
}
const SessionHTML = new Map(); // slug -> {html, blobURL}
recentGrid.addEventListener('click', async (e)=>{
  const open = e.target.closest('[data-open]');
  const copy = e.target.closest('[data-copy]');
  if(open){
    const slug = open.getAttribute('data-open');
    const item = SessionHTML.get(slug);
    if(!item){ open.textContent='No disponible'; return; }
    window.open(item.blobURL, '_blank', 'noopener');
  }
  if(copy){
    const slug = copy.getAttribute('data-copy');
    const item = SessionHTML.get(slug);
    if(!item){ copy.textContent='No disponible'; return; }
    await navigator.clipboard.writeText(item.html);
    copy.textContent='¡Copiado!';
    setTimeout(()=> copy.textContent='Copiar código', 1200);
  }
});

/* ====== Envío al Webhook de Make (espera HTML) ====== */
const TIMEOUT_MS = 60000;
function validHex(s){ return /^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6})$/.test((s||'').trim()); }

async function sendToMake(payload){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort('timeout'), TIMEOUT_MS);
  let r;
  try{
    r = await fetch(MAKE_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'Accept':'text/html' },
      body: JSON.stringify(payload),
      signal: ctrl.signal
    });
  }catch(e){
    clearTimeout(t);
    if(e.name === 'AbortError') throw new Error('Timeout del servidor (60s).');
    throw new Error('No se pudo conectar: ' + e.message);
  }
  clearTimeout(t);

  const html = await r.text();
  if(!r.ok) throw new Error('Status ' + r.status + '. ' + html.slice(0,200));
  if(!/^<!doctype html/i.test(html) || !/<\/html>/i.test(html)) throw new Error('La respuesta no es un HTML completo.');
  return html;
}

/* Generación desde el chat */
async function generateFromPrompt(){
  const text = composer.value.trim();
  if(!text){ composer.focus(); addMsg('system','Escribe un prompt o elige una plantilla ☝️'); return; }

  const brief = BriefStore.get() || {
    brand_name:'PsicoFunnel Demo',
    niche:'coaches/cursos',
    goal:'captar leads',
    tone:'claro y profesional',
    color_primary:'#0ea5e9',
    color_accent:'#0b5fff',
    offer_price: 49,
    offer_guarantee: 'Garantía 7 días',
    style_keywords:'liquid glass, minimalista, premium'
  };
  if(!validHex(brief.color_primary) || !validHex(brief.color_accent)){
    addMsg('system','Color inválido. Usa formato #rrggbb.'); return;
  }
  const sections = (selectedTemplate?.sections) || ["hero","benefits","leadform","faq","footer"];
  const project_slug = (brief.brand_name || 'demo')
    .toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'').slice(0,40)
    + '-' + Math.random().toString(36).slice(2,6);

  const payload = {
    project_slug,
    brand: { name: brief.brand_name || 'PsicoFunnel', colors: { primary: brief.color_primary, accent: brief.color_accent } },
    niche: brief.niche || 'general',
    goal: brief.goal || 'captar leads',
    tone: brief.tone || 'claro y profesional',
    offer: { price: brief.offer_price ? String(brief.offer_price) : undefined, guarantee: brief.offer_guarantee || undefined },
    sections,
    prompt: text   // ⚠️ enviamos el prompt libre al webhook para que GPT lo respete
  };

  addMsg('user', text);
  const thinking = addMsg('assistant', 'Generando tu funnel… ⏳');

  try{
    const html = await sendToMake(payload);
    thinking.remove();

    // Guarda en memoria de sesión y en "Recientes" (metadatos)
    if(lastBlobURL) URL.revokeObjectURL(lastBlobURL);
    lastHTML = html;
    lastBlobURL = URL.createObjectURL(new Blob([html], {type:'text/html;charset=utf-8'}));
    SessionHTML.set(project_slug, {html, blobURL:lastBlobURL});
    RecentStore.push({ slug: project_slug, title: (brief.brand_name||'Marca') + ' — ' + (selectedTemplate?.name || 'custom'), ts: Date.now() });
    renderRecents();

    // Abre modal de preview
    previewFrame.removeAttribute('sandbox'); // si quieres aislar: previewFrame.setAttribute('sandbox','allow-scripts allow-forms');
    previewFrame.srcdoc = html;
    codeBox.textContent = html;
    previewModal.classList.remove('show-code');
    setPreview(true);

    addMsg('assistant', `Listo ✅ Abre la preview para ver/descargar tu landing.`);

    composer.value=''; selectedTemplate = null;
  }catch(err){
    thinking.textContent = 'Hubo un problema: ' + (err.message || err);
    if(String(err).includes('CORS')){
      addMsg('system','Parece CORS. Usa un proxy /api/psico-make-generate o habilita los headers CORS en el Webhook response.');
    }
  }
}

/* Eventos del chat */
sendBtn.addEventListener('click', generateFromPrompt);
composer.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); generateFromPrompt(); }
});

/* Demo rápida */
loadDemoBtn.addEventListener('click', ()=>{
  composer.value = "Crea una landing opt-in para un checklist de productividad (3 beneficios y FAQ). Tono claro, profesional, sin promesas vacías. CTA a ‘Recibir mi checklist’.";
  addMsg('assistant','Cargué un prompt de ejemplo. ¡Dale a Generar!');
});

/* Preview modal actions */
toggleCodeBtn.addEventListener('click', ()=> previewModal.classList.toggle('show-code'));
downloadBtn.addEventListener('click', ()=>{
  if(!lastHTML.trim()) return;
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([lastHTML], {type:'text/html;charset=utf-8'}));
  a.download = 'index.html';
  a.click();
  setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
});
openTabBtn.addEventListener('click', ()=>{ if(lastBlobURL) window.open(lastBlobURL,'_blank','noopener'); });
closePreviewBtn.addEventListener('click', ()=> setPreview(false));

/* Init */
renderRecents();
</script>
</body>
</html>

